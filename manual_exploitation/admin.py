# manual_exploitation/admin.py
from django.contrib import admin
from .models import (
    ExploitationSession, ExploitationLog, 
    ExploitationEvidence, SafetyControl,
    ExploitationTemplate
)

class ExploitationLogInline(admin.TabularInline):
    model = ExploitationLog
    extra = 0
    readonly_fields = ('timestamp', 'level', 'message')
    can_delete = False
    
    def has_add_permission(self, request, obj=None):
        return False


class ExploitationEvidenceInline(admin.TabularInline):
    model = ExploitationEvidence
    extra = 0
    readonly_fields = ('timestamp', 'evidence_type', 'name')


@admin.register(ExploitationSession)
class ExploitationSessionAdmin(admin.ModelAdmin):
    list_display = ('name', 'target', 'vulnerability', 'status', 'created_at', 'success')
    list_filter = ('status', 'success', 'created_at')
    search_fields = ('name', 'target', 'vulnerability__name', 'exploit__title')
    readonly_fields = ('created_at', 'started_at', 'completed_at', 'success')
    inlines = [ExploitationLogInline, ExploitationEvidenceInline]
    
    fieldsets = (
        ('Basic Information', {
            'fields': ('name', 'target', 'description', 'status')
        }),
        ('Related Objects', {
            'fields': ('vulnerability', 'exploit')
        }),
        ('Execution Details', {
            'fields': ('customized_code', 'parameters', 'result_summary', 'success')
        }),
        ('Safety', {
            'fields': ('safety_checks_performed', 'scope_limitations', 'max_execution_time', 'authorized_by')
        }),
        ('Timing', {
            'fields': ('created_at', 'started_at', 'completed_at')
        }),
        ('Notes', {
            'fields': ('notes', 'tags')
        })
    )


@admin.register(ExploitationLog)
class ExploitationLogAdmin(admin.ModelAdmin):
    list_display = ('timestamp', 'session', 'level', 'message_preview')
    list_filter = ('level', 'timestamp', 'session__status')
    search_fields = ('message', 'session__name', 'session__target')
    readonly_fields = ('timestamp', 'session')
    
    def message_preview(self, obj):
        """Return a preview of the message"""
        if len(obj.message) > 100:
            return obj.message[:100] + '...'
        return obj.message
    
    message_preview.short_description = 'Message'


@admin.register(ExploitationEvidence)
class ExploitationEvidenceAdmin(admin.ModelAdmin):
    list_display = ('name', 'session', 'evidence_type', 'timestamp')
    list_filter = ('evidence_type', 'timestamp', 'session__status')
    search_fields = ('name', 'description', 'session__name', 'session__target')
    readonly_fields = ('timestamp', 'session')


@admin.register(SafetyControl)
class SafetyControlAdmin(admin.ModelAdmin):
    list_display = ('name', 'control_type', 'is_mandatory')
    list_filter = ('control_type', 'is_mandatory')
    search_fields = ('name', 'description')


@admin.register(ExploitationTemplate)
class ExploitationTemplateAdmin(admin.ModelAdmin):
    list_display = ('name', 'exploit_type', 'created_at')
    list_filter = ('exploit_type', 'created_at')
    search_fields = ('name', 'description', 'template_code')
    filter_horizontal = ('required_safety_controls',)