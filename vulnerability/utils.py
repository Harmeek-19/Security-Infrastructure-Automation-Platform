# Add to vulnerability/utils.py

import requests
from requests.adapters import HTTPAdapter
from urllib3.util.retry import Retry  # âœ… Correct

import logging

logger = logging.getLogger(__name__)

def create_http_session(retries=3, backoff_factor=0.3, status_forcelist=(500, 502, 504)):
    """Create a requests session with retry capability"""
    session = requests.Session()
    retry = Retry(
        total=retries,
        read=retries,
        connect=retries,
        backoff_factor=backoff_factor,
        status_forcelist=status_forcelist,
    )
    adapter = HTTPAdapter(max_retries=retry)
    session.mount('http://', adapter)
    session.mount('https://', adapter)
    return session

def check_target_accessibility(target: str) -> bool:
    """Check if target is accessible"""
    session = create_http_session()
    try:
        # Try HTTPS first
        response = session.get(f"https://{target}", timeout=10, verify=False)
        return True
    except requests.exceptions.SSLError:
        try:
            # Try HTTP if HTTPS fails
            response = session.get(f"http://{target}", timeout=10)
            return True
        except requests.exceptions.RequestException as e:
            logger.warning(f"Target {target} is not accessible: {str(e)}")
            return False
    except requests.exceptions.RequestException as e:
        logger.warning(f"Target {target} is not accessible: {str(e)}")
        return False