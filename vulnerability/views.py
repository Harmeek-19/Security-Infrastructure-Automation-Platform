from django.http import JsonResponse
from django.views import View
from django.views.decorators.csrf import csrf_exempt
from django.utils.decorators import method_decorator


from .unified_scanner import UnifiedVulnerabilityScanner
from .models import Vulnerability
import json
import logging

logger = logging.getLogger(__name__)

@method_decorator(csrf_exempt, name='dispatch')
class VulnerabilityScanView(View):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.scanner = UnifiedVulnerabilityScanner()

    def post(self, request):
        try:
            data = json.loads(request.body)
            target = data.get('target')
            scan_type = data.get('scan_type', 'standard')
            include_zap = data.get('include_zap', True)

            if not target:
                return JsonResponse({
                    'status': 'error',
                    'error': 'Target is required'
                }, status=400)

            logger.info(f"Starting vulnerability scan for {target}")
            results = self.scanner.scan_target(target, scan_type, include_zap)
            
            return JsonResponse(results)

        except json.JSONDecodeError:
            return JsonResponse({
                'status': 'error',
                'error': 'Invalid JSON data'
            }, status=400)
        except Exception as e:
            logger.exception(f"Error during vulnerability scan: {str(e)}")
            return JsonResponse({
                'status': 'error',
                'error': str(e)
            }, status=500)

class VulnerabilityListView(View):
    def get(self, request):
        try:
            # Get filter parameters
            target = request.GET.get('target')
            severity = request.GET.get('severity')
            vuln_type = request.GET.get('type')
            source = request.GET.get('source')
            include_fixed = request.GET.get('include_fixed', 'false').lower() == 'true'

            # Build query
            query = Vulnerability.objects.all()
            if target:
                query = query.filter(target=target)
            if severity:
                query = query.filter(severity=severity.upper())
            if vuln_type:
                query = query.filter(vuln_type=vuln_type)
            if source:
                query = query.filter(source=source)
            if not include_fixed:
                query = query.filter(is_fixed=False)

            # Get vulnerabilities with selected fields
            vulnerabilities = query.values(
                'id', 'target', 'name', 'description', 'severity',
                'vuln_type', 'evidence', 'source', 'confidence',
                'discovery_date', 'is_fixed', 'fix_date', 'cvss_score'
            ).order_by('-discovery_date')

            return JsonResponse({
                'status': 'success',
                'count': len(vulnerabilities),
                'vulnerabilities': list(vulnerabilities)
            })

        except Exception as e:
            logger.error(f"Error listing vulnerabilities: {str(e)}")
            return JsonResponse({
                'status': 'error',
                'error': str(e)
            }, status=500)

@method_decorator(csrf_exempt, name='dispatch')
class VulnerabilityUpdateView(View):
    def post(self, request, vuln_id):
        try:
            vulnerability = Vulnerability.objects.get(id=vuln_id)
            data = json.loads(request.body)

            # Update fields
            if 'is_fixed' in data:
                vulnerability.is_fixed = data['is_fixed']
            if 'notes' in data:
                vulnerability.notes = data['notes']
            if 'severity' in data:
                vulnerability.severity = data['severity'].upper()

            vulnerability.save()

            return JsonResponse({
                'status': 'success',
                'vulnerability': {
                    'id': vulnerability.id,
                    'name': vulnerability.name,
                    'is_fixed': vulnerability.is_fixed,
                    'notes': vulnerability.notes,
                    'severity': vulnerability.severity
                }
            })

        except Vulnerability.DoesNotExist:
            return JsonResponse({
                'status': 'error',
                'error': 'Vulnerability not found'
            }, status=404)
        except Exception as e:
            logger.error(f"Error updating vulnerability: {str(e)}")
            return JsonResponse({
                'status': 'error',
                'error': str(e)
            }, status=500)

class ScannerStatusView(View):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.scanner = UnifiedVulnerabilityScanner()

    def get(self, request):
        try:
            status = self.scanner.get_scanner_status()
            return JsonResponse({
                'status': 'success',
                'scanners': status
            })
        except Exception as e:
            logger.error(f"Error getting scanner status: {str(e)}")
            return JsonResponse({
                'status': 'error',
                'error': str(e)
            }, status=500)
            
# vulnerability/views.py (Add these views to your existing views.py)

from django.http import JsonResponse
from django.views import View
from django.views.decorators.csrf import csrf_exempt
from django.utils.decorators import method_decorator
from .nuclei_scanner import NucleiScanner
from .models import NucleiFinding
import json
import logging

logger = logging.getLogger(__name__)

@method_decorator(csrf_exempt, name='dispatch')
class NucleiScanView(View):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.scanner = NucleiScanner()

    def post(self, request):
        try:
            data = json.loads(request.body)
            target = data.get('target')
            scan_type = data.get('scan_type', 'basic')  # Default to basic scan
            scan_options = data.get('options', {})

            if not target:
                return JsonResponse({
                    'status': 'error',
                    'error': 'Target is required'
                }, status=400)

            # Choose scan type
            if scan_type == 'basic':
                logger.info(f"Starting basic Nuclei scan for {target}")
                scan_results = self.scanner.run_basic_scan(target)
            elif scan_type == 'advanced':
                logger.info(f"Starting advanced Nuclei scan for {target}")
                scan_results = self.scanner.run_advanced_scan(target, scan_options)
            else:
                logger.info(f"Starting custom Nuclei scan for {target}")
                scan_results = self.scanner.scan_target(target, scan_options)
            
            if scan_results.get('status') == 'success':
                # Prepare response with summary and limited findings
                findings = scan_results.get('findings', [])
                # Limit findings in response to first 10
                limited_findings = findings[:10] if len(findings) > 10 else findings
                
                response_data = {
                    'status': 'success',
                    'message': f'Nuclei scan completed for {target}',
                    'scan_id': scan_results.get('scan_id'),
                    'findings_count': len(findings),
                    'findings': limited_findings,  # Limit to first 10 for response size
                    'summary': scan_results.get('summary'),
                    'note': "Response limited to 10 findings" if len(findings) > 10 else ""
                }
                
                # Save findings to database
                saved_findings = []
                for finding in findings:
                    try:
                        nuclei_finding = NucleiFinding.objects.create(
                            template_id=finding.get('template_id', ''),
                            name=finding.get('name', ''),
                            severity=finding.get('severity', 'unknown').upper(),
                            finding_type=finding.get('type', ''),
                            host=finding.get('host', ''),
                            matched_at=finding.get('matched', ''),
                            description=finding.get('description', ''),
                            tags=finding.get('tags', []),
                            references=finding.get('references', []),
                            cwe=finding.get('cwe', ''),
                            cvss_score=finding.get('cvss_score'),
                            scan_id=scan_results.get('scan_id', ''),
                            target=target
                        )
                        saved_findings.append({
                            'id': nuclei_finding.id,
                            'name': nuclei_finding.name,
                            'severity': nuclei_finding.severity
                        })
                    except Exception as e:
                        logger.error(f"Error saving finding: {str(e)}")
                
                return JsonResponse(response_data)
            else:
                return JsonResponse({
                    'status': 'error',
                    'error': scan_results.get('error', 'Unknown error during scan')
                }, status=500)

        except json.JSONDecodeError:
            return JsonResponse({
                'status': 'error',
                'error': 'Invalid JSON data'
            }, status=400)
        except Exception as e:
            logger.error(f"Error during Nuclei scan: {str(e)}")
            return JsonResponse({
                'status': 'error',
                'error': str(e)
            }, status=500)
            
class NucleiTemplatesView(View):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.scanner = NucleiScanner()

    def get(self, request):
        """Get information about available Nuclei templates"""
        try:
            template_info = self.scanner.get_template_info()
            return JsonResponse(template_info)
        except Exception as e:
            logger.error(f"Error getting template info: {str(e)}")
            return JsonResponse({
                'status': 'error',
                'error': str(e)
            }, status=500)

    def post(self, request):
        """Update Nuclei templates"""
        try:
            update_result = self.scanner.update_templates()
            return JsonResponse(update_result)
        except Exception as e:
            logger.error(f"Error updating templates: {str(e)}")
            return JsonResponse({
                'status': 'error',
                'error': str(e)
            }, status=500)

class NucleiFindingsView(View):
    def get(self, request):
        """Get Nuclei findings with optional filters"""
        try:
            target = request.GET.get('target')
            severity = request.GET.get('severity')
            template_id = request.GET.get('template_id')
            
            query = NucleiFinding.objects.all()
            if target:
                query = query.filter(target=target)
            if severity:
                query = query.filter(severity=severity.upper())
            if template_id:
                query = query.filter(template_id=template_id)
                
            findings = query.values(
                'id', 'template_id', 'name', 'severity',
                'finding_type', 'host', 'matched_at',
                'discovery_date', 'cvss_score'
            ).order_by('-discovery_date')
            
            return JsonResponse({
                'status': 'success',
                'count': len(findings),
                'findings': list(findings)
            })
            
        except Exception as e:
            logger.error(f"Error retrieving Nuclei findings: {str(e)}")
            return JsonResponse({
                'status': 'error',
                'error': str(e)
            }, status=500)