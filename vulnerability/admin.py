from django.contrib import admin
from django.utils.html import format_html
from .models import Vulnerability

@admin.register(Vulnerability)
class VulnerabilityAdmin(admin.ModelAdmin):
    list_display = ('target', 'name', 'colored_severity', 'vuln_type', 'source', 
                   'discovery_date', 'is_fixed', 'cvss_score')
    list_filter = ('severity', 'vuln_type', 'source', 'is_fixed', 'discovery_date')
    search_fields = ('target', 'name', 'description')
    readonly_fields = ('discovery_date', 'fix_date')
    ordering = ('-discovery_date',)
    
    fieldsets = (
        ('Basic Information', {
            'fields': ('target', 'name', 'description', 'severity', 'vuln_type')
        }),
        ('Details', {
            'fields': ('evidence', 'solution', 'references')
        }),
        ('Source Information', {
            'fields': ('source', 'confidence')
        }),
        ('Status', {
            'fields': ('is_fixed', 'discovery_date', 'fix_date', 'notes')
        }),
        ('Technical Details', {
            'fields': ('cwe', 'cvss_score', 'metadata'),
            'classes': ('collapse',)
        }),
    )

    def colored_severity(self, obj):
        colors = {
            'CRITICAL': 'darkred',
            'HIGH': 'red',
            'MEDIUM': 'orange',
            'LOW': 'green'
        }
        return format_html(
            '<span style="color: {};">{}</span>',
            colors.get(obj.severity, 'black'),
            obj.severity
        )
    colored_severity.short_description = 'Severity'

    def has_add_permission(self, request):
        # Vulnerabilities should only be created through scans
        return False