import docker
import logging
import time
from django.conf import settings
import requests
from typing import Dict, Optional

class ZAPManager:
    def __init__(self):
        self.logger = logging.getLogger(__name__)
        self.client = docker.from_env()
        self.container_name = 'security_platform_zap'
        self.api_key = getattr(settings, 'ZAP_API_KEY', 'change_me_please')
        self.zap_address = f"http://{getattr(settings, 'ZAP_HOST', 'localhost')}:{getattr(settings, 'ZAP_PORT', 8080)}"

    def ensure_zap_running(self) -> bool:
        """Ensure ZAP container is running, start if not"""
        try:
            container = self.client.containers.get(self.container_name)
            if container.status != 'running':
                container.start()
                time.sleep(10)  # Wait for ZAP to initialize
            
            # Verify ZAP is responding
            return self._check_zap_api()
            
        except docker.errors.NotFound:
            self.logger.info("ZAP container not found, starting new one")
            return self._start_zap_container()
        except Exception as e:
            self.logger.error(f"Error ensuring ZAP is running: {str(e)}")
            return False

    def _start_zap_container(self) -> bool:
        """Start a new ZAP container"""
        try:
            container = self.client.containers.run(
                'ghcr.io/zaproxy/zaproxy:stable',
                command=f'zap.sh -daemon -host 0.0.0.0 -port 8080 -config api.addrs.addr.name=.* -config api.addrs.addr.regex=true -config api.key={self.api_key}',
                ports={'8080/tcp': 8080},
                name=self.container_name,
                detach=True
            )
            time.sleep(10)  # Wait for ZAP to initialize
            return self._check_zap_api()
        except Exception as e:
            self.logger.error(f"Error starting ZAP container: {str(e)}")
            return False

    def _check_zap_api(self) -> bool:
        """Check if ZAP API is responding"""
        try:
            response = requests.get(
                f"{self.zap_address}/JSON/core/view/version/",
                params={'apikey': self.api_key},
                timeout=5
            )
            return response.status_code == 200
        except Exception as e:
            self.logger.error(f"Error checking ZAP API: {str(e)}")
            return False

    def get_status(self) -> Dict:
        """Get detailed ZAP status including API and container status"""
        status = {
            'container': None,
            'api': False,
            'version': None,
            'error': None
        }

        try:
            # Check container status
            container = self.client.containers.get(self.container_name)
            status['container'] = container.status

            # Check API status
            api_response = requests.get(
                f"{self.zap_address}/JSON/core/view/version/",
                params={'apikey': self.api_key},
                timeout=5
            )
            if api_response.status_code == 200:
                status['api'] = True
                status['version'] = api_response.json().get('version', 'unknown')

        except docker.errors.NotFound:
            status['error'] = 'Container not found'
        except requests.exceptions.RequestException as e:
            status['error'] = f'API error: {str(e)}'
        except Exception as e:
            status['error'] = f'Unexpected error: {str(e)}'

        return status

    def test_connection(self, target_url: str) -> Dict:
        """Test ZAP connection by performing a simple spider scan"""
        try:
            # Start a spider scan
            response = requests.get(
                f"{self.zap_address}/JSON/spider/action/scan/",
                params={
                    'apikey': self.api_key,
                    'url': target_url,
                    'maxChildren': '1',  # Limit scan for testing
                    'recurse': 'false'
                },
                timeout=30
            )
            
            if response.status_code == 200:
                scan_id = response.json().get('scan')
                return {
                    'status': 'success',
                    'message': 'Test scan initiated successfully',
                    'scan_id': scan_id
                }
            else:
                return {
                    'status': 'error',
                    'message': f'Failed to initiate test scan: {response.text}'
                }

        except Exception as e:
            return {
                'status': 'error',
                'message': f'Connection test failed: {str(e)}'
            }