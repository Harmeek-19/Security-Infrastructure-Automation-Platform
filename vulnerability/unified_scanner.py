from typing import Dict, List
import logging
from datetime import datetime
from .scanner import VulnerabilityScanner
from .zap_manager import ZAPManager
from .models import Vulnerability

class UnifiedVulnerabilityScanner:
    def __init__(self):
        self.logger = logging.getLogger(__name__)
        self.internal_scanner = VulnerabilityScanner()
        self.zap_manager = ZAPManager()

    def scan_target(self, target: str, scan_type: str = 'standard', include_zap: bool = True) -> Dict:
        """
        Perform a comprehensive scan using both internal scanner and ZAP
        """
        results = {
            'target': target,
            'scan_start': datetime.now().isoformat(),
            'vulnerabilities': [],
            'scanners_used': ['internal'],
            'summary': {
                'high': 0,
                'medium': 0,
                'low': 0,
                'total': 0
            }
        }

        try:
            # Run internal scanner
            internal_results = self.internal_scanner.scan_target(target)
            self._process_internal_results(results, internal_results)

            # Run ZAP scan if requested
            if include_zap:
                if self.zap_manager.ensure_zap_running():
                    results['scanners_used'].append('zap')
                    zap_results = self.zap_manager.run_scan(target)
                    if zap_results.get('status') == 'success':
                        self._process_zap_results(results, zap_results)
                else:
                    self.logger.warning("ZAP scanner not available")

            # Deduplicate findings
            results['vulnerabilities'] = self._deduplicate_findings(results['vulnerabilities'])
            
            # Update summary
            self._update_summary(results)
            
            results['scan_end'] = datetime.now().isoformat()
            results['status'] = 'success'
            
            # Save findings to database
            self._save_findings(results['vulnerabilities'], target)
            
            return results

        except Exception as e:
            self.logger.error(f"Unified scan failed: {str(e)}")
            return {
                'status': 'error',
                'error': str(e),
                'scan_end': datetime.now().isoformat()
            }

    def _process_internal_results(self, results: Dict, internal_results: Dict) -> None:
        """Process results from internal scanner"""
        if internal_results.get('vulnerabilities'):
            for vuln in internal_results['vulnerabilities']:
                results['vulnerabilities'].append({
                    'source': 'internal',
                    'name': vuln.get('name', ''),
                    'description': vuln.get('description', ''),
                    'severity': vuln.get('severity', 'LOW'),
                    'type': vuln.get('type', ''),
                    'evidence': vuln.get('evidence', ''),
                    'confidence': vuln.get('confidence', 'medium'),
                    'cvss_score': vuln.get('cvss', 0.0)
                })

    def _process_zap_results(self, results: Dict, zap_results: Dict) -> None:
        """Process results from ZAP scanner"""
        if zap_results.get('alerts'):
            for alert in zap_results['alerts']:
                results['vulnerabilities'].append({
                    'source': 'zap',
                    'name': alert.get('name', ''),
                    'description': alert.get('description', ''),
                    'severity': self._normalize_severity(alert.get('risk')),
                    'type': 'web',
                    'evidence': alert.get('evidence', ''),
                    'confidence': alert.get('confidence', 'medium'),
                    'solution': alert.get('solution', ''),
                    'cwe': alert.get('cweid', ''),
                    'metadata': {
                        'url': alert.get('url', ''),
                        'parameter': alert.get('parameter', '')
                    }
                })

    def _deduplicate_findings(self, vulnerabilities: List[Dict]) -> List[Dict]:
        """Deduplicate findings from different scanners"""
        unique_findings = {}
        
        for vuln in vulnerabilities:
            # Create a key for deduplication
            key = f"{vuln['name']}_{vuln['severity']}"
            
            if key in unique_findings:
                existing = unique_findings[key]
                # Merge sources
                sources = set([existing['source']])
                sources.add(vuln['source'])
                existing['source'] = ','.join(sources)
                # Take highest confidence
                existing['confidence'] = max(existing['confidence'], vuln['confidence'])
                # Merge evidence
                if vuln.get('evidence'):
                    existing['evidence'] = f"{existing['evidence']}\n{vuln['source']}: {vuln['evidence']}"
            else:
                unique_findings[key] = vuln

        return list(unique_findings.values())

    def _normalize_severity(self, severity: str) -> str:
        """Normalize severity ratings"""
        severity = str(severity).lower()
        
        if severity in ['critical', 'high', '3', '4']:
            return 'HIGH'
        elif severity in ['medium', 'warning', '2']:
            return 'MEDIUM'
        elif severity in ['low', 'info', '1']:
            return 'LOW'
        return 'INFO'

    def _update_summary(self, results: Dict) -> None:
        """Update the summary counts"""
        summary = {'high': 0, 'medium': 0, 'low': 0, 'total': 0}
        
        for vuln in results['vulnerabilities']:
            severity = vuln['severity'].lower()
            if severity in summary:
                summary[severity] += 1
            summary['total'] += 1

        results['summary'] = summary

    def _save_findings(self, vulnerabilities: List[Dict], target: str) -> None:
        """Save findings to database"""
        for vuln in vulnerabilities:
            Vulnerability.objects.create(
                target=target,
                name=vuln['name'],
                description=vuln.get('description', ''),
                severity=vuln['severity'],
                vuln_type=vuln.get('type', 'unknown'),
                evidence=vuln.get('evidence', ''),
                source=vuln['source'],
                confidence=vuln['confidence'],
                solution=vuln.get('solution', ''),
                cwe=vuln.get('cwe', ''),
                cvss_score=vuln.get('cvss_score'),
                metadata=vuln.get('metadata', {})
            )

    def get_scanner_status(self) -> Dict:
        """Get status of all scanners"""
        status = {
            'internal': {
                'status': 'available',
                'checks': list(self.internal_scanner.checks.keys())
            },
            'zap': self.zap_manager.get_status()
        }
        return status