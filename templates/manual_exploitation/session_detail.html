{% extends 'base.html' %}

{% block title %}Exploitation Session: {{ session.name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>{{ session.name }}</h1>
        <div>
            <a href="{% url 'manual_exploitation:session_list' %}" class="btn btn-outline-secondary">Back to Sessions</a>
            <a href="{% url 'manual_exploitation:dashboard' %}" class="btn btn-outline-primary">Dashboard</a>
        </div>
    </div>
    
    <div class="row">
        <!-- Session Details Column -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Session Details</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-3">
                        <span>Status:</span>
                        <span class="badge bg-{% if session.status == 'completed' and session.success %}success{% elif session.status == 'created' %}secondary{% elif session.status == 'authorized' %}info{% elif session.status == 'in_progress' %}warning{% else %}danger{% endif %}">
                            {{ session.status|title }}
                        </span>
                    </div>
                    
                    <div class="d-flex justify-content-between mb-3">
                        <span>Target:</span>
                        <span class="fw-bold">{{ session.target }}</span>
                    </div>
                    
                    <div class="d-flex justify-content-between mb-3">
                        <span>Created:</span>
                        <span>{{ session.created_at|date:"Y-m-d H:i:s" }}</span>
                    </div>
                    
                    {% if session.started_at %}
                    <div class="d-flex justify-content-between mb-3">
                        <span>Started:</span>
                        <span>{{ session.started_at|date:"Y-m-d H:i:s" }}</span>
                    </div>
                    {% endif %}
                    
                    {% if session.completed_at %}
                    <div class="d-flex justify-content-between mb-3">
                        <span>Completed:</span>
                        <span>{{ session.completed_at|date:"Y-m-d H:i:s" }}</span>
                    </div>
                    {% endif %}
                    
                    {% if session.status == 'completed' %}
                    <div class="d-flex justify-content-between mb-3">
                        <span>Result:</span>
                        <span class="fw-bold {% if session.success %}text-success{% else %}text-danger{% endif %}">
                            {% if session.success %}Success{% else %}Failed{% endif %}
                        </span>
                    </div>
                    {% endif %}
                    
                    {% if session.authorized_by %}
                    <div class="d-flex justify-content-between mb-3">
                        <span>Authorized by:</span>
                        <span>{{ session.authorized_by }}</span>
                    </div>
                    {% endif %}
                    
                    <div class="d-flex justify-content-between mb-3">
                        <span>Safety Checks:</span>
                        <span class="{% if session.safety_checks_performed %}text-success{% else %}text-danger{% endif %}">
                            {% if session.safety_checks_performed %}Performed{% else %}Not Performed{% endif %}
                        </span>
                    </div>
                    
                    <hr>
                    
                    <h6>Vulnerability</h6>
                    <div class="mb-3">
                        <div class="d-flex align-items-center mb-1">
                            <span class="badge bg-{% if session.vulnerability.severity == 'CRITICAL' %}danger{% elif session.vulnerability.severity == 'HIGH' %}warning{% elif session.vulnerability.severity == 'MEDIUM' %}info{% else %}secondary{% endif %} me-2">
                                {{ session.vulnerability.severity }}
                            </span>
                            <span>{{ session.vulnerability.name }}</span>
                        </div>
                        <small class="text-muted">{{ session.vulnerability.description|truncatechars:150 }}</small>
                    </div>
                    
                    <h6>Exploit</h6>
                    <div class="mb-3">
                        <div>{{ session.exploit.title }}</div>
                        <small class="text-muted">ID: {{ session.exploit.exploit_id }}</small>
                    </div>
                    
                    {% if session.result_summary %}
                    <h6>Result Summary</h6>
                    <div class="mb-3">
                        <div class="alert alert-{% if session.success %}success{% else %}danger{% endif %}">
                            {{ session.result_summary }}
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if session.description %}
                    <h6>Description</h6>
                    <div class="mb-3">
                        <p>{{ session.description }}</p>
                    </div>
                    {% endif %}
                    
                    {% if session.scope_limitations %}
                    <h6>Scope Limitations</h6>
                    <div class="mb-3">
                        <p>{{ session.scope_limitations }}</p>
                    </div>
                    {% endif %}
                </div>
                <div class="card-footer">
                    <div class="d-grid gap-2">
                        {% if session.status == 'created' %}
                            <button class="btn btn-success" id="authorizeBtn">
                                <i class="bi bi-check-circle"></i> Authorize
                            </button>
                        {% endif %}
                        
                        {% if session.status == 'authorized' %}
                            <button class="btn btn-primary" id="executeBtn">
                                <i class="bi bi-play-fill"></i> Execute
                            </button>
                        {% endif %}
                        
                        {% if session.status == 'in_progress' %}
                            <button class="btn btn-danger" id="abortBtn">
                                <i class="bi bi-x-circle"></i> Abort
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Parameters Section -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">Parameters</h5>
                </div>
                <div class="card-body">
                    {% if session.parameters %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Value</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for key, value in session.parameters.items %}
                                        <tr>
                                            <td><code>{{ key }}</code></td>
                                            <td><code>{{ value }}</code></td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted">No parameters configured for this session.</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Evidence Section -->
            <div class="card">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Evidence</h5>
                    <button class="btn btn-sm btn-light" data-bs-toggle="modal" data-bs-target="#addEvidenceModal">
                        <i class="bi bi-plus"></i> Add
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for item in evidence %}
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">{{ item.name }}</h6>
                                        <small class="text-muted">{{ item.evidence_type|title }} - {{ item.timestamp|date:"Y-m-d H:i:s" }}</small>
                                    </div>
                                    <button class="btn btn-sm btn-outline-primary view-evidence-btn" 
                                           data-evidence-id="{{ item.id }}"
                                           data-evidence-name="{{ item.name }}"
                                           data-evidence-type="{{ item.evidence_type }}"
                                           data-evidence-content="{{ item.content|escape }}"
                                           data-evidence-description="{{ item.description|escape }}">
                                        <i class="bi bi-eye"></i> View
                                    </button>
                                </div>
                                {% if item.description %}
                                    <p class="mb-0 small text-muted mt-1">{{ item.description|truncatechars:100 }}</p>
                                {% endif %}
                            </div>
                        {% empty %}
                            <div class="list-group-item text-center text-muted py-3">
                                <i class="bi bi-file-earmark-x"></i> No evidence collected
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content Column -->
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="code-tab" data-bs-toggle="tab" data-bs-target="#code-tab-pane" type="button" role="tab" aria-controls="code-tab-pane" aria-selected="true">
                                Exploit Code
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs-tab-pane" type="button" role="tab" aria-controls="logs-tab-pane" aria-selected="false">
                                Activity Log
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="results-tab" data-bs-toggle="tab" data-bs-target="#results-tab-pane" type="button" role="tab" aria-controls="results-tab-pane" aria-selected="false">
                                Results
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content">
                        <!-- Code Tab -->
                        <div class="tab-pane fade show active" id="code-tab-pane" role="tabpanel" aria-labelledby="code-tab" tabindex="0">
                            {% if session.status in 'created,authorized' %}
                                <div class="mb-3">
                                    <div class="d-flex justify-content-end mb-2">
                                        <button class="btn btn-sm btn-outline-secondary" id="formatCodeBtn">
                                            <i class="bi bi-code-square"></i> Format Code
                                        </button>
                                    </div>
                                    <textarea id="codeEditor" class="form-control code-editor" rows="20" style="font-family: monospace;">{{ session.customized_code }}</textarea>
                                    <div class="d-flex justify-content-end mt-2">
                                        <button class="btn btn-primary" id="saveCodeBtn">
                                            <i class="bi bi-save"></i> Save Changes
                                        </button>
                                    </div>
                                </div>
                            {% else %}
                                <pre class="bg-light p-3" style="max-height: 600px; overflow-y: auto;"><code>{{ session.customized_code }}</code></pre>
                            {% endif %}
                        </div>
                        
                        <!-- Logs Tab -->
                        <div class="tab-pane fade" id="logs-tab-pane" role="tabpanel" aria-labelledby="logs-tab" tabindex="0">
                            <div class="logs-container" style="max-height: 600px; overflow-y: auto;">
                                {% if logs %}
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover">
                                            <thead>
                                                <tr>
                                                    <th style="width: 180px;">Timestamp</th>
                                                    <th style="width: 100px;">Level</th>
                                                    <th>Message</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for log in logs %}
                                                    <tr>
                                                        <td>{{ log.timestamp|date:"Y-m-d H:i:s" }}</td>
                                                        <td>
                                                            <span class="badge bg-{% if log.level == 'error' or log.level == 'critical' %}danger{% elif log.level == 'warning' %}warning{% elif log.level == 'success' %}success{% elif log.level == 'debug' %}secondary{% else %}info{% endif %}">
                                                                {{ log.level|upper }}
                                                            </span>
                                                        </td>
                                                        <td>{{ log.message|linebreaksbr }}</td>
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% else %}
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle"></i> No logs available for this session yet.
                                    </div>
                                {% endif %}
                            </div>
                            <div class="d-flex justify-content-end mt-3">
                                <button class="btn btn-outline-secondary" id="refreshLogsBtn">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh Logs
                                </button>
                            </div>
                        </div>
                        
                        <!-- Results Tab -->
                        <div class="tab-pane fade" id="results-tab-pane" role="tabpanel" aria-labelledby="results-tab" tabindex="0">
                            {% if session.status == 'completed' or session.status == 'failed' %}
                                <div class="alert alert-{% if session.success %}success{% else %}danger{% endif %} mb-4">
                                    <h5 class="alert-heading">
                                        {% if session.success %}
                                            <i class="bi bi-check-circle"></i> Exploitation Succeeded
                                        {% else %}
                                            <i class="bi bi-x-circle"></i> Exploitation Failed
                                        {% endif %}
                                    </h5>
                                    <hr>
                                    <p class="mb-0">{{ session.result_summary }}</p>
                                </div>
                                
                                <!-- Show evidence summary in results tab too -->
                                <h5>Evidence Collected</h5>
                                {% if evidence %}
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Name</th>
                                                    <th>Type</th>
                                                    <th>Timestamp</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for item in evidence %}
                                                    <tr>
                                                        <td>{{ item.name }}</td>
                                                        <td>{{ item.evidence_type|title }}</td>
                                                        <td>{{ item.timestamp|date:"Y-m-d H:i:s" }}</td>
                                                        <td>
                                                            <button class="btn btn-sm btn-outline-primary view-evidence-btn" 
                                                                   data-evidence-id="{{ item.id }}"
                                                                   data-evidence-name="{{ item.name }}"
                                                                   data-evidence-type="{{ item.evidence_type }}"
                                                                   data-evidence-content="{{ item.content|escape }}"
                                                                   data-evidence-description="{{ item.description|escape }}">
                                                                <i class="bi bi-eye"></i> View
                                                            </button>
                                                        </td>
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% else %}
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle"></i> No evidence was collected during this exploitation session.
                                    </div>
                                {% endif %}
                            {% else %}
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i> 
                                    {% if session.status == 'in_progress' %}
                                        Exploitation is currently in progress. Results will be available once completed.
                                    {% else %}
                                        This session has not been executed yet. Execute the session to see results.
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Authorize Modal -->
<div class="modal fade" id="authorizeModal" tabindex="-1" aria-labelledby="authorizeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="authorizeModalLabel">Authorize Session</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Please confirm your authorization for this exploitation session:</p>
                
                <div class="mb-3">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="authScopeCheck" required>
                        <label class="form-check-label" for="authScopeCheck">
                            I confirm that the target is within authorized scope
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="authSafetyCheck" required>
                        <label class="form-check-label" for="authSafetyCheck">
                            I confirm that all safety controls have been properly implemented
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="authResponsibilityCheck" required>
                        <label class="form-check-label" for="authResponsibilityCheck">
                            I understand the responsibility of authorizing this exploitation attempt
                        </label>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="authorizedBy" class="form-label">Authorized By:</label>
                    <input type="text" class="form-control" id="authorizedBy" placeholder="Your name" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmAuthorize">Authorize</button>
            </div>
        </div>
    </div>
</div>

<!-- Execute Modal -->
<div class="modal fade" id="executeModal" tabindex="-1" aria-labelledby="executeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="executeModalLabel">Execute Session</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <strong>Warning:</strong> You are about to execute an exploitation attempt. This action will run the code configured in the session against the target.
                </div>
                <p>Please confirm that you want to proceed with execution.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmExecute">Execute</button>
            </div>
        </div>
    </div>
</div>

<!-- Abort Modal -->
<div class="modal fade" id="abortModal" tabindex="-1" aria-labelledby="abortModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="abortModalLabel">Abort Session</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to abort this exploitation session? This action cannot be undone.</p>
                <div class="mb-3">
                    <label for="abortReason" class="form-label">Reason for aborting:</label>
                    <textarea class="form-control" id="abortReason" rows="3" required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmAbort">Abort Session</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Evidence Modal -->
<div class="modal fade" id="addEvidenceModal" tabindex="-1" aria-labelledby="addEvidenceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="addEvidenceModalLabel">Add Evidence</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="evidenceForm">
                    <div class="mb-3">
                        <label for="evidenceName" class="form-label">Evidence Name</label>
                        <input type="text" class="form-control" id="evidenceName" name="name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="evidenceType" class="form-label">Evidence Type</label>
                        <select class="form-select" id="evidenceType" name="evidence_type" required>
                            <option value="screenshot">Screenshot</option>
                            <option value="log">Log File</option>
                            <option value="data">Extracted Data</option>
                            <option value="traffic">Network Traffic</option>
                            <option value="response">Server Response</option>
                            <option value="output">Command Output</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="evidenceDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="evidenceDescription" name="description" rows="2"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="evidenceContent" class="form-label">Content</label>
                        <textarea class="form-control" id="evidenceContent" name="content" rows="10" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="saveEvidenceBtn">Save Evidence</button>
            </div>
        </div>
    </div>
</div>

<!-- View Evidence Modal -->
<div class="modal fade" id="viewEvidenceModal" tabindex="-1" aria-labelledby="viewEvidenceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="viewEvidenceModalLabel">View Evidence</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <h5 id="viewEvidenceName"></h5>
                    <span class="badge bg-secondary mb-2" id="viewEvidenceType"></span>
                    <p class="text-muted" id="viewEvidenceDescription"></p>
                </div>
                
                <div class="mb-3">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>Evidence Content</span>
                            <button class="btn btn-sm btn-outline-secondary" id="copyEvidenceBtn">
                                <i class="bi bi-clipboard"></i> Copy
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <pre class="m-0 p-3 bg-light" style="max-height: 400px; overflow-y: auto;"><code id="viewEvidenceContent"></code></pre>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="downloadEvidenceBtn">Download</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Initialize code editor if available
    let codeEditor;
    if (typeof CodeMirror !== 'undefined') {
        codeEditor = CodeMirror.fromTextArea(document.getElementById('codeEditor'), {
            lineNumbers: true,
            mode: 'python',
            theme: 'monokai',
            indentUnit: 4
        });
    }
    
    // Handle authorize button
    $('#authorizeBtn').click(function() {
        $('#authorizeModal').modal('show');
    });
    
    // Handle execute button
    $('#executeBtn').click(function() {
        $('#executeModal').modal('show');
    });
    
    // Handle abort button
    $('#abortBtn').click(function() {
        $('#abortModal').modal('show');
    });
    
    // Handle save code button
    $('#saveCodeBtn').click(function() {
        // Get code from CodeMirror if available, otherwise from textarea
        const code = codeEditor ? codeEditor.getValue() : $('#codeEditor').val();
        
        $.ajax({
            url: window.location.pathname + '/update_code/',
            type: 'POST',
            data: JSON.stringify({ code: code }),
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': getCsrfToken()
            },
            success: function(response) {
                showToast('Code saved successfully', 'success');
            },
            error: function(xhr, status, error) {
                showToast('Error saving code: ' + error, 'danger');
            }
        });
    });
    
    // Handle format code button
    $('#formatCodeBtn').click(function() {
        if (codeEditor) {
            // This is a simple indentation formatter
            // In a real implementation, you might use a more sophisticated formatter
            codeEditor.execCommand('selectAll');
            codeEditor.execCommand('indentAuto');
        }
    });
    
    // Handle confirm authorize
    $('#confirmAuthorize').click(function() {
        // Check required checkboxes
        if (!$('#authScopeCheck').prop('checked') || 
            !$('#authSafetyCheck').prop('checked') || 
            !$('#authResponsibilityCheck').prop('checked')) {
            showToast('Please confirm all checkboxes before authorizing.', 'warning');
            return;
        }
        
        const authorizedBy = $('#authorizedBy').val();
        if (!authorizedBy) {
            showToast('Please enter your name for authorization.', 'warning');
            return;
        }
        
        $.ajax({
            url: window.location.pathname + '/authorize/',
            type: 'POST',
            data: JSON.stringify({ authorized_by: authorizedBy }),
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': getCsrfToken()
            },
            success: function(response) {
                $('#authorizeModal').modal('hide');
                showToast('Session authorized successfully', 'success');
                window.location.reload();
            },
            error: function(xhr, status, error) {
                showToast('Error authorizing session: ' + error, 'danger');
            }
        });
    });
    
    // Handle confirm execute
    $('#confirmExecute').click(function() {
        $.ajax({
            url: window.location.pathname + '/execute/',
            type: 'POST',
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': getCsrfToken()
            },
            success: function(response) {
                $('#executeModal').modal('hide');
                showToast('Execution started successfully', 'success');
                startLogPolling();
                window.location.reload();
            },
            error: function(xhr, status, error) {
                showToast('Error executing session: ' + error, 'danger');
            }
        });
    });
    
    // Handle confirm abort
    $('#confirmAbort').click(function() {
        const reason = $('#abortReason').val();
        if (!reason) {
            showToast('Please provide a reason for aborting.', 'warning');
            return;
        }
        
        $.ajax({
            url: window.location.pathname + '/abort/',
            type: 'POST',
            data: JSON.stringify({ reason: reason }),
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': getCsrfToken()
            },
            success: function(response) {
                $('#abortModal').modal('hide');
                showToast('Session aborted successfully', 'success');
                window.location.reload();
            },
            error: function(xhr, status, error) {
                showToast('Error aborting session: ' + error, 'danger');
            }
        });
    });
    
    // Handle save evidence
    $('#saveEvidenceBtn').click(function() {
        const name = $('#evidenceName').val();
        const evidenceType = $('#evidenceType').val();
        const description = $('#evidenceDescription').val();
        const content = $('#evidenceContent').val();
        
        if (!name || !content) {
            showToast('Please provide a name and content for the evidence.', 'warning');
            return;
        }
        
        $.ajax({
            url: window.location.pathname + '/add_evidence/',
            type: 'POST',
            data: JSON.stringify({
                name: name,
                evidence_type: evidenceType,
                description: description,
                content: content
            }),
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': getCsrfToken()
            },
            success: function(response) {
                $('#addEvidenceModal').modal('hide');
                showToast('Evidence added successfully', 'success');
                window.location.reload();
            },
            error: function(xhr, status, error) {
                showToast('Error adding evidence: ' + error, 'danger');
            }
        });
    });
    
    // Handle view evidence button
    $('.view-evidence-btn').click(function() {
        const id = $(this).data('evidence-id');
        const name = $(this).data('evidence-name');
        const type = $(this).data('evidence-type');
        const content = $(this).data('evidence-content');
        const description = $(this).data('evidence-description');
        
        $('#viewEvidenceName').text(name);
        $('#viewEvidenceType').text(type);
        $('#viewEvidenceDescription').text(description || 'No description provided');
        $('#viewEvidenceContent').text(content);
        
        $('#viewEvidenceModal').modal('show');
    });
    
    // Handle copy evidence
    $('#copyEvidenceBtn').click(function() {
        const content = $('#viewEvidenceContent').text();
        
        navigator.clipboard.writeText(content)
            .then(() => {
                showToast('Evidence content copied to clipboard', 'success');
            })
            .catch(err => {
                showToast('Failed to copy content: ' + err, 'danger');
            });
    });
    
    // Handle download evidence
    $('#downloadEvidenceBtn').click(function() {
        const name = $('#viewEvidenceName').text();
        const content = $('#viewEvidenceContent').text();
        
        // Create a blob and download link
        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = name.replace(/\s+/g, '_') + '.txt';
        document.body.appendChild(a);
        a.click();
        
        // Cleanup
        setTimeout(function() {
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }, 0);
    });
    
    // Handle refresh logs button
    $('#refreshLogsBtn').click(function() {
        $.ajax({
            url: window.location.pathname + '/logs/',
            type: 'GET',
            success: function(response) {
                // In a real implementation, this would update the logs table
                window.location.reload();
            }
        });
    });
    
    // Log polling for in-progress sessions
    function startLogPolling() {
        if ('{{ session.status }}' === 'in_progress') {
            const pollInterval = setInterval(function() {
                $.ajax({
                    url: window.location.pathname + '/status/',
                    type: 'GET',
                    success: function(response) {
                        if (response.status !== 'in_progress') {
                            clearInterval(pollInterval);
                            window.location.reload();
                        }
                    }
                });
            }, 5000); // Poll every 5 seconds
        }
    }
    
    // Helper to get CSRF token
    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }
    
    // Helper to show toast notifications
    function showToast(message, type) {
        // Check if toast container exists, create if not
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        // Create toast element
        const toastId = 'toast-' + Date.now();
        const toastHtml = `
            <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header bg-${type} text-white">
                    <strong class="me-auto">Notification</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            </div>
        `;
        
        // Append toast to container
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        
        // Initialize and show toast
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
        toast.show();
        
        // Remove toast after it's hidden
        toastElement.addEventListener('hidden.bs.toast', function() {
            toastElement.remove();
        });
    }
    
    // Initialize log polling on page load
    startLogPolling();
});
</script>
{% endblock %}