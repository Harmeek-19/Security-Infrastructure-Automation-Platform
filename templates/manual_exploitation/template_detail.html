{% extends 'base.html' %}

{% block title %}Template: {{ template.name }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Template Details</h1>
        <div>
            <a href="{% url 'manual_exploitation:template_list' %}" class="btn btn-outline-secondary">Back to Templates</a>
            <a href="{% url 'manual_exploitation:session_create' %}?template_id={{ template.id }}" class="btn btn-primary">Use Template</a>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">{{ template.name }}</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <span class="badge bg-secondary me-2">{{ template.exploit_type }}</span>
                        <small class="text-muted">Created: {{ template.created_at|date:"Y-m-d H:i" }}</small>
                        <small class="text-muted ms-2">Updated: {{ template.updated_at|date:"Y-m-d H:i" }}</small>
                    </div>
                    
                    <div class="mb-4">
                        <h6>Description</h6>
                        <p>{{ template.description }}</p>
                    </div>
                    
                    <div class="mb-4">
                        <h6>Template Code</h6>
                        <pre class="bg-light p-3"><code>{{ template.template_code }}</code></pre>
                    </div>
                    
                    <div class="mb-4">
                        <h6>Parameters</h6>
                        {% if template.parameters %}
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Parameter</th>
                                            <th>Default Value</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for key, value in template.parameters.items %}
                                            <tr>
                                                <td><code>{{ key }}</code></td>
                                                <td><code>{{ value }}</code></td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <p class="text-muted">No parameters defined</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Edit Template</h5>
                </div>
                <div class="card-body">
                    <form id="editTemplateForm">
                        <div class="mb-3">
                            <label for="templateName" class="form-label">Template Name</label>
                            <input type="text" class="form-control" id="templateName" name="name" value="{{ template.name }}" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="templateType" class="form-label">Template Type</label>
                            <select class="form-select" id="templateType" name="exploit_type" required>
                                <option value="web" {% if template.exploit_type == 'web' %}selected{% endif %}>Web Application</option>
                                <option value="sqli" {% if template.exploit_type == 'sqli' %}selected{% endif %}>SQL Injection</option>
                                <option value="cmdi" {% if template.exploit_type == 'cmdi' %}selected{% endif %}>Command Injection</option>
                                <option value="xss" {% if template.exploit_type == 'xss' %}selected{% endif %}>Cross-Site Scripting</option>
                                <option value="other" {% if template.exploit_type == 'other' %}selected{% endif %}>Other</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="templateDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="templateDescription" name="description" rows="3" required>{{ template.description }}</textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="templateCode" class="form-label">Template Code</label>
                            <textarea class="form-control code-editor" id="templateCode" name="template_code" rows="12" required>{{ template.template_code }}</textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Parameter Definitions</label>
                            <div id="parametersContainer">
                                {% for key, value in template.parameters.items %}
                                    <div class="row mb-2 parameter-row">
                                        <div class="col-md-5">
                                            <input type="text" class="form-control param-key" value="{{ key }}" placeholder="Parameter name">
                                        </div>
                                        <div class="col-md-6">
                                            <input type="text" class="form-control param-value" value="{{ value }}" placeholder="Default value">
                                        </div>
                                        <div class="col-md-1">
                                            <button type="button" class="btn btn-danger btn-sm remove-param">×</button>
                                        </div>
                                    </div>
                                {% empty %}
                                    <div class="row mb-2 parameter-row">
                                        <div class="col-md-5">
                                            <input type="text" class="form-control param-key" placeholder="Parameter name">
                                        </div>
                                        <div class="col-md-6">
                                            <input type="text" class="form-control param-value" placeholder="Default value">
                                        </div>
                                        <div class="col-md-1">
                                            <button type="button" class="btn btn-danger btn-sm remove-param">×</button>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            <button type="button" class="btn btn-outline-secondary mt-2" id="addParameterBtn">
                                <i class="fas fa-plus"></i> Add Parameter
                            </button>
                            <input type="hidden" id="parametersJson" name="parameters" value="{{ template.parameters|json }}">
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="button" class="btn btn-danger" id="deleteTemplateBtn">Delete Template</button>
                            <button type="submit" class="btn btn-primary">Update Template</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">Required Safety Controls</h5>
                </div>
                <div class="card-body">
                    {% if template.required_safety_controls.all %}
                        <ul class="list-group">
                            {% for control in template.required_safety_controls.all %}
                                <li class="list-group-item">
                                    <h6 class="mb-1">{{ control.name }}</h6>
                                    <p class="small mb-0">{{ control.description }}</p>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted">No required safety controls</p>
                    {% endif %}
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">Usage Instructions</h5>
                </div>
                <div class="card-body">
                    <ol class="small">
                        <li>Create a new exploitation session</li>
                        <li>Select this template</li>
                        <li>Configure parameters for your specific target</li>
                        <li>Customize code if needed</li>
                        <li>Acknowledge safety controls</li>
                        <li>Get authorization and execute</li>
                    </ol>
                    
                    <div class="alert alert-warning mt-3 small">
                        <strong>Note:</strong> Always ensure that you have proper authorization before using any exploitation template.
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="card-title mb-0">Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'manual_exploitation:session_create' %}?template_id={{ template.id }}" class="btn btn-primary">
                            <i class="fas fa-play"></i> Use This Template
                        </a>
                        <button class="btn btn-secondary" id="copyTemplateBtn">
                            <i class="fas fa-copy"></i> Copy Code
                        </button>
                        <button class="btn btn-info" id="downloadTemplateBtn">
                            <i class="fas fa-download"></i> Download Template
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalLabel">Delete Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this template? This action cannot be undone.</p>
                <div class="alert alert-warning">
                    <strong>Warning:</strong> Deleting this template will remove it from all associated exploitation sessions.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete Template</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Initialize code editor if available
    if (typeof CodeMirror !== 'undefined') {
        const editor = CodeMirror.fromTextArea(document.getElementById('templateCode'), {
            lineNumbers: true,
            mode: 'python',
            theme: 'monokai',
            indentUnit: 4
        });
    }
    
    // Handle add parameter button
    $('#addParameterBtn').click(function() {
        const newRow = `
            <div class="row mb-2 parameter-row">
                <div class="col-md-5">
                    <input type="text" class="form-control param-key" placeholder="Parameter name">
                </div>
                <div class="col-md-6">
                    <input type="text" class="form-control param-value" placeholder="Default value">
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-danger btn-sm remove-param">×</button>
                </div>
            </div>
        `;
        $('#parametersContainer').append(newRow);
    });
    
    // Handle parameter removal
    $(document).on('click', '.remove-param', function() {
        $(this).closest('.parameter-row').remove();
    });
    
    // Handle form submission
    $('#editTemplateForm').submit(function(e) {
        e.preventDefault();
        
        // Serialize parameters
        const params = {};
        $('.parameter-row').each(function() {
            const key = $(this).find('.param-key').val();
            const value = $(this).find('.param-value').val();
            
            if (key) {
                params[key] = value;
            }
        });
        
        $('#parametersJson').val(JSON.stringify(params));
        
        // Get form data
        const formData = new FormData(this);
        
        // Convert FormData to object
        const data = {};
        formData.forEach((value, key) => {
            data[key] = value;
        });
        
        // Submit the form via AJAX
        $.ajax({
            url: window.location.pathname,
            type: 'POST',
            data: JSON.stringify(data),
            contentType: 'application/json',
            success: function(response) {
                alert('Template updated successfully');
                window.location.reload();
            },
            error: function(xhr, status, error) {
                alert('Error updating template: ' + error);
            }
        });
    });
    
    // Handle delete button
    $('#deleteTemplateBtn').click(function() {
        $('#deleteModal').modal('show');
    });
    
    // Handle delete confirmation
    $('#confirmDelete').click(function() {
        $.ajax({
            url: window.location.pathname,
            type: 'DELETE',
            success: function(response) {
                window.location.href = '{% url "manual_exploitation:template_list" %}';
            },
            error: function(xhr, status, error) {
                alert('Error deleting template: ' + error);
            }
        });
    });
    
    // Handle copy template code
    $('#copyTemplateBtn').click(function() {
        const copyText = document.getElementById('templateCode').value;
        
        // Create a temporary textarea element to copy from
        const textArea = document.createElement('textarea');
        textArea.value = copyText;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        alert('Template code copied to clipboard');
    });
    
    // Handle download template
    $('#downloadTemplateBtn').click(function() {
        const templateData = {
            name: '{{ template.name }}',
            exploit_type: '{{ template.exploit_type }}',
            description: '{{ template.description }}',
            code: document.getElementById('templateCode').value,
            parameters: JSON.parse(document.getElementById('parametersJson').value)
        };
        
        // Create a download link for the JSON data
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(templateData, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", templateData.name.replace(/\s+/g, '_') + ".json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    });
});
</script>
{% endblock %}