{% extends 'base.html' %}

{% block title %}Exploitation Templates{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Exploitation Templates</h1>
        <div>
            <a href="{% url 'manual_exploitation:dashboard' %}" class="btn btn-outline-secondary">Back to Dashboard</a>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTemplateModal">
                <i class="bi bi-plus-circle"></i> Create Template
            </button>
        </div>
    </div>
    
    <div class="row">
        <!-- Sidebar/Filters -->
        <div class="col-md-3 mb-4">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="card-title mb-0">Template Types</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        <a href="{% url 'manual_exploitation:template_list' %}" class="list-group-item list-group-item-action {% if not type_filter %}active{% endif %}">
                            All Templates
                        </a>
                        <a href="{% url 'manual_exploitation:template_list' %}?type=web" class="list-group-item list-group-item-action {% if type_filter == 'web' %}active{% endif %}">
                            Web Application
                        </a>
                        <a href="{% url 'manual_exploitation:template_list' %}?type=sqli" class="list-group-item list-group-item-action {% if type_filter == 'sqli' %}active{% endif %}">
                            SQL Injection
                        </a>
                        <a href="{% url 'manual_exploitation:template_list' %}?type=cmdi" class="list-group-item list-group-item-action {% if type_filter == 'cmdi' %}active{% endif %}">
                            Command Injection
                        </a>
                        <a href="{% url 'manual_exploitation:template_list' %}?type=xss" class="list-group-item list-group-item-action {% if type_filter == 'xss' %}active{% endif %}">
                            Cross-Site Scripting
                        </a>
                        <a href="{% url 'manual_exploitation:template_list' %}?type=other" class="list-group-item list-group-item-action {% if type_filter == 'other' %}active{% endif %}">
                            Other
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Template Cards -->
        <div class="col-md-9">
            <div class="row">
                {% for template in templates %}
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="card-title mb-0">{{ template.name }}</h5>
                            </div>
                            <div class="card-body">
                                <h6 class="text-muted">{{ template.exploit_type }}</h6>
                                <p class="card-text">{{ template.description|truncatechars:150 }}</p>
                            </div>
                            <div class="card-footer d-flex justify-content-between">
                                <small class="text-muted">Updated: {{ template.updated_at|date:"M d, Y" }}</small>
                                <div>
                                    <a href="{% url 'manual_exploitation:template_detail' template.id %}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye"></i> View
                                    </a>
                                    <button class="btn btn-sm btn-outline-secondary use-template-btn" 
                                            data-template-id="{{ template.id }}"
                                            data-template-name="{{ template.name }}">
                                        <i class="bi bi-code"></i> Use
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> No templates available. Create your first template to get started.
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Create Template Modal -->
<div class="modal fade" id="createTemplateModal" tabindex="-1" aria-labelledby="createTemplateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="createTemplateModalLabel">Create Exploitation Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'manual_exploitation:template_list' %}" id="createTemplateForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="name" class="form-label">Template Name</label>
                        <input type="text" class="form-control" id="name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="exploit_type" class="form-label">Exploit Type</label>
                        <select class="form-select" id="exploit_type" name="exploit_type" required>
                            <option value="">Select type...</option>
                            <option value="web">Web Application</option>
                            <option value="sqli">SQL Injection</option>
                            <option value="cmdi">Command Injection</option>
                            <option value="xss">Cross-Site Scripting</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="template_code" class="form-label">Template Code</label>
                        <textarea class="form-control code-editor" id="template_code" name="template_code" rows="10" style="font-family: monospace;"></textarea>
                        <small class="form-text text-muted">
                            Use {target} for target placeholder, and {param_name} for other parameters.
                        </small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Parameters</label>
                        <div id="parameters_container">
                            <!-- Parameters will be added here dynamically -->
                            <div class="input-group mb-2 parameter-row">
                                <input type="text" class="form-control param-name" placeholder="Parameter Name">
                                <input type="text" class="form-control param-default" placeholder="Default Value">
                                <button type="button" class="btn btn-outline-danger remove-param">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-primary" id="add_parameter_btn">
                            <i class="bi bi-plus"></i> Add Parameter
                        </button>
                        <input type="hidden" id="parameters_json" name="parameters" value="{}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Required Safety Controls</label>
                        <div class="safety-controls-container">
                            {% for control in safety_controls %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="safety_controls" value="{{ control.id }}" id="control_{{ control.id }}">
                                    <label class="form-check-label" for="control_{{ control.id }}">
                                        {{ control.name }} ({{ control.control_type }})
                                    </label>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Template</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Use Template Modal -->
<div class="modal fade" id="useTemplateModal" tabindex="-1" aria-labelledby="useTemplateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="useTemplateModalLabel">Use Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>How would you like to use <strong id="selectedTemplateName"></strong>?</p>
                
                <div class="d-grid gap-2">
                    <a href="#" class="btn btn-primary" id="useTemplateCreateSessionBtn">
                        <i class="bi bi-plus-circle"></i> Create New Session with Template
                    </a>
                    <button class="btn btn-outline-secondary" id="useTemplateCopyBtn">
                        <i class="bi bi-clipboard"></i> Copy Template Code
                    </button>
                    <button class="btn btn-outline-info" id="useTemplateDownloadBtn">
                        <i class="bi bi-download"></i> Download Template
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle parameter operations
    document.getElementById('add_parameter_btn').addEventListener('click', function() {
        const container = document.getElementById('parameters_container');
        const newRow = document.createElement('div');
        newRow.className = 'input-group mb-2 parameter-row';
        newRow.innerHTML = `
            <input type="text" class="form-control param-name" placeholder="Parameter Name">
            <input type="text" class="form-control param-default" placeholder="Default Value">
            <button type="button" class="btn btn-outline-danger remove-param">
                <i class="bi bi-trash"></i>
            </button>
        `;
        container.appendChild(newRow);
        
        // Add event listener to the new remove button
        newRow.querySelector('.remove-param').addEventListener('click', function() {
            container.removeChild(newRow);
        });
    });
    
    // Add event listeners to initial remove-param buttons
    document.querySelectorAll('.remove-param').forEach(button => {
        button.addEventListener('click', function() {
            this.closest('.parameter-row').remove();
        });
    });
    
    // Handle form submission to collect parameters
    document.getElementById('createTemplateForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Collect parameters
        const parameters = {};
        document.querySelectorAll('.parameter-row').forEach(row => {
            const name = row.querySelector('.param-name').value.trim();
            const defaultValue = row.querySelector('.param-default').value.trim();
            if (name) {
                parameters[name] = defaultValue;
            }
        });
        
        // Set parameters JSON
        document.getElementById('parameters_json').value = JSON.stringify(parameters);
        
        // Submit the form
        this.submit();
    });
    
    // Handle use template buttons
    document.querySelectorAll('.use-template-btn').forEach(button => {
        button.addEventListener('click', function() {
            const templateId = this.getAttribute('data-template-id');
            const templateName = this.getAttribute('data-template-name');
            
            // Set modal content
            document.getElementById('selectedTemplateName').textContent = templateName;
            document.getElementById('useTemplateCreateSessionBtn').href = `/exploitation/sessions/create/?template_id=${templateId}`;
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('useTemplateModal'));
            modal.show();
        });
    });
    
    // Handle copy template button
    document.getElementById('useTemplateCopyBtn').addEventListener('click', function() {
        const templateId = document.getElementById('useTemplateCreateSessionBtn').href.split('template_id=')[1];
        
        // Fetch template code via AJAX
        fetch(`/exploitation/templates/${templateId}/code/`)
            .then(response => response.text())
            .then(code => {
                navigator.clipboard.writeText(code)
                    .then(() => {
                        alert('Template code copied to clipboard');
                    })
                    .catch(err => {
                        alert('Failed to copy template code: ' + err);
                    });
            })
            .catch(error => {
                alert('Error fetching template code: ' + error);
            });
    });
    
    // Handle download template button
    document.getElementById('useTemplateDownloadBtn').addEventListener('click', function() {
        const templateId = document.getElementById('useTemplateCreateSessionBtn').href.split('template_id=')[1];
        const templateName = document.getElementById('selectedTemplateName').textContent;
        
        // Redirect to download URL
        window.location.href = `/exploitation/templates/${templateId}/download/`;
    });
});